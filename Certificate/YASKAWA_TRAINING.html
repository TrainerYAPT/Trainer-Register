<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YASKAWA Training Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4 text-center">ลงทะเบียนรับใบ Certificate - YASKAWA Training</h2>
    <form id="registrationForm">
      <div class="mb-3">
        <label for="fullname" class="form-label">ชื่อ - นามสกุล (ภาษาอังกฤษตัวใหญ่เท่านั้น)</label>
        <input type="text" class="form-control" id="fullname" required>
      </div>
      <div class="mb-3">
        <label for="phone" class="form-label">เบอร์โทรศัพท์</label>
        <input type="tel" class="form-control" id="phone" required>
      </div>
      <div class="mb-3">
        <label for="email" class="form-label">อีเมล</label>
        <input type="email" class="form-control" id="email" required>
      </div>
      <div class="mb-3">
        <label for="company" class="form-label">ชื่อบริษัท / สถานศึกษา</label>
        <input type="text" class="form-control" id="company" required>
      </div>
      <div class="mb-3">
        <label for="course" class="form-label">หลักสูตรที่เข้าอบรม</label>
        <select class="form-select" id="course" required>
          <option selected disabled>เลือกหลักสูตร</option>
          <option value="ROBOT BASIC OPERATION">ROBOT BASIC OPERATION</option>
          <option value="ROBOT INSTRUCTION">ROBOT INSTRUCTION</option>
          <option value="ROBOT ADVANCE">ROBOT ADVANCE</option>
          <option value="ROBOT MAINTENANCE">ROBOT MAINTENANCE</option>
          <option value="ROBOT INSPECTION">ROBOT INSPECTION</option>
          <option value="ROBOT MECHANICAL EXCHANGE">ROBOT MECHANICAL EXCHANGE</option>
          <option value="ROBOT ARC WELDING">ROBOT ARC WELDING</option>
          <option value="ROBOT SPOT WELDING">ROBOT SPOT WELDING</option>
          <option value="ROBOT I/O SIGNAL">ROBOT I/O SIGNAL</option>
          <option value="MOTOSIM ROBOT">MOTOSIM ROBOT</option>
          <option value="BASIC COMMUNICATION CONVEYOR">BASIC COMMUNICATION CONVEYOR</option>
          <option value="BASIC COMMUNICATION CAMERA">BASIC COMMUNICATION CAMERA</option>
          <option value="BASIC COMMUNICATION PLC">BASIC COMMUNICATION PLC</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="date" class="form-label">วันที่อบรม</label>
        <input type="date" class="form-control" id="date" required>
      </div>
      <div class="mb-3">
        <label for="trainer" class="form-label">เลือกเทรนเนอร์ผู้ลงนาม</label>
        <select class="form-select" id="trainer" required>
          <option selected disabled>เลือกชื่อเทรนเนอร์</option>
          <option value="Naruechai-Chimwat-01.png">Naruechai C.</option>
          <option value="PRAPAT-01.png">Prapat T.</option>
          <option value="Thanaphat-Larungsit-01.png">Thanaphat L.</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">ลงทะเบียน</button>
      <button type="reset" class="btn btn-secondary ms-2">ล้างฟอร์ม</button>
    </form>
    <div class="alert alert-success mt-3 d-none" id="successMsg">บันทึกข้อมูลเรียบร้อยแล้ว! กำลังดาวน์โหลดใบ Certificate...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics.js";
    import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzrftZGGWZlTErQGihqif-wRJdDaUf8XE",
      authDomain: "trainer-regist.firebaseapp.com",
      projectId: "trainer-regist",
      storageBucket: "trainer-regist.firebasestorage.app",
      messagingSenderId: "376323496330",
      appId: "1:376323496330:web:1d0c13024e98eb209b5073",
      measurementId: "G-MQZX51QNV9"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    const form = document.getElementById("registrationForm");
    const successMsg = document.getElementById("successMsg");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      const fullname = document.getElementById("fullname").value.trim().toUpperCase();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const company = document.getElementById("company").value.trim();
      const course = document.getElementById("course").value;
      const date = document.getElementById("date").value;
      const trainer = document.getElementById("trainer").value;

      const data = { fullname, phone, email, company, course, date, trainer };

      try {
        await addDoc(collection(db, "trainee_submissions"), data);
        successMsg.classList.remove("d-none");
        await generateCertificate(data);
        form.reset();
        setTimeout(() => successMsg.classList.add("d-none"), 3000);
        submitBtn.disabled = false;
      } catch (err) {
        alert("เกิดข้อผิดพลาด: " + err.message);
        submitBtn.disabled = false;
      }
    });

    async function loadImageAsBase64(url) {
      const response = await fetch(url);
      const blob = await response.blob();
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    async function generateCertificate(data) {
      const doc = new jsPDF({ orientation: "landscape" });
      const bg = await loadImageAsBase64("Certificate/ROBOT-CERTIFICATE-BG-01.jpg");
      const sign = await loadImageAsBase64(`Certificate/${data.trainer}`);

      doc.addImage(bg, "JPEG", 0, 0, 297, 210);
      doc.setFontSize(24);
      doc.text(data.fullname, 148, 100, { align: "center" });
      doc.setFontSize(16);
      doc.text(data.course, 148, 115, { align: "center" });
      doc.text("Date: " + data.date, 148, 125, { align: "center" });

      doc.addImage(sign, "PNG", 200, 135, 60, 25);
      doc.save(`Certificate_${data.fullname}.pdf`);
    }
  </script>
</body>
</html>
